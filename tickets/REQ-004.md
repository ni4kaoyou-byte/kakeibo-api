# REQ-004 データモデル定義

- Status: Done
- Priority: Must
- Depends On: REQ-003

## Goal

永続化モデル（テーブル、制約、関連）を確定する。

## Selected Pattern

- パターン1: 正規化CRUD型（MVP向け）
- テーブル: `users`, `categories`, `transactions`, `budgets`

## Table Definitions

### `users`

| Column | Type | Constraint | Note |
|---|---|---|---|
| id | BIGSERIAL | PK | ユーザーID |
| email | VARCHAR(255) | NOT NULL, UNIQUE | ログインID |
| password_hash | VARCHAR(255) | NOT NULL | ハッシュのみ保持 |
| display_name | VARCHAR(100) | NOT NULL | 表示名 |
| timezone | VARCHAR(40) | NOT NULL DEFAULT `Asia/Tokyo` | REQ-003よりJST固定運用 |
| created_at | TIMESTAMPTZ | NOT NULL DEFAULT now() | 作成日時 |
| updated_at | TIMESTAMPTZ | NOT NULL DEFAULT now() | 更新日時 |

### `categories`

| Column | Type | Constraint | Note |
|---|---|---|---|
| id | BIGSERIAL | PK | カテゴリID |
| user_id | BIGINT | NOT NULL, FK -> users(id) | 所有者 |
| type | VARCHAR(10) | NOT NULL CHECK (`type IN ('income','expense')`) | 収支種別 |
| name | VARCHAR(30) | NOT NULL | カテゴリ名 |
| is_active | BOOLEAN | NOT NULL DEFAULT true | 無効化対応 |
| created_at | TIMESTAMPTZ | NOT NULL DEFAULT now() | 作成日時 |
| updated_at | TIMESTAMPTZ | NOT NULL DEFAULT now() | 更新日時 |

追加制約:
- UNIQUE (`user_id`, `type`, `lower(name)`) 相当を実装する（同一ユーザー内で重複禁止）

### `transactions`

| Column | Type | Constraint | Note |
|---|---|---|---|
| id | BIGSERIAL | PK | 取引ID |
| user_id | BIGINT | NOT NULL, FK -> users(id) | 所有者 |
| category_id | BIGINT | NOT NULL, FK -> categories(id) | カテゴリ |
| type | VARCHAR(10) | NOT NULL CHECK (`type IN ('income','expense')`) | 収支種別 |
| amount | INTEGER | NOT NULL CHECK (`amount >= 1 AND amount <= 9999999`) | 金額（JPY） |
| transaction_date | DATE | NOT NULL | 取引日（未来日付チェックはアプリ層） |
| note | VARCHAR(255) | NULL | メモ |
| deleted_at | TIMESTAMPTZ | NULL | 論理削除 |
| created_at | TIMESTAMPTZ | NOT NULL DEFAULT now() | 作成日時 |
| updated_at | TIMESTAMPTZ | NOT NULL DEFAULT now() | 更新日時 |

### `budgets` (MVP外だが将来拡張のため定義)

| Column | Type | Constraint | Note |
|---|---|---|---|
| id | BIGSERIAL | PK | 予算ID |
| user_id | BIGINT | NOT NULL, FK -> users(id) | 所有者 |
| category_id | BIGINT | NULL, FK -> categories(id) | NULLなら全体予算 |
| year_month | CHAR(7) | NOT NULL | `YYYY-MM` |
| amount | INTEGER | NOT NULL CHECK (`amount >= 1 AND amount <= 9999999`) | 予算額 |
| created_at | TIMESTAMPTZ | NOT NULL DEFAULT now() | 作成日時 |
| updated_at | TIMESTAMPTZ | NOT NULL DEFAULT now() | 更新日時 |

追加制約:
- UNIQUE (`user_id`, `category_id`, `year_month`)

## Indexes

- `idx_categories_user_type_active` on (`user_id`, `type`, `is_active`)
- `idx_transactions_user_date` on (`user_id`, `transaction_date`) where `deleted_at IS NULL`
- `idx_transactions_user_type_date` on (`user_id`, `type`, `transaction_date`) where `deleted_at IS NULL`
- `idx_budgets_user_month` on (`user_id`, `year_month`)

## Relationship

- `users (1) - (N) categories`
- `users (1) - (N) transactions`
- `users (1) - (N) budgets`
- `categories (1) - (N) transactions`
- `categories (1) - (N) budgets` (optional)

## Flyway Migration Plan

1. `V2__create_users.sql`
2. `V3__create_categories.sql`
3. `V4__create_transactions.sql`
4. `V5__create_budgets.sql`
5. `V6__add_indexes_and_constraints.sql`

方針:
- 破壊的変更は新規 migration で段階的に実施。
- 既存 `V1__init.sql` は後方互換のため触らない（別 migration で置換）。

## Notes

- 日次・月次・年次集計は `transactions.transaction_date` を軸に集計する。
- 収支は `deleted_at IS NULL` かつログインユーザーIDで必ずフィルタする。
- ER図は `docs/er-diagram.md` を参照する。

## Acceptance Criteria

- [x] 主キー・外部キー・ユニーク制約が定義されている
- [x] 日次・月次・年次集計に必要なカラムが過不足なくある
- [x] Flywayで段階的に作成可能な設計になっている
