# REQ-005 API契約定義

- Status: Done
- Priority: Must
- Depends On: REQ-003, REQ-004

## Goal

REST API の入出力とエラー契約を定義する。

## Final Decision

- Pattern C: CQRS-lite（Command/Query分離）を採用する。
- 書き込み系と読み取り系でエンドポイントを分離する。
- 認可は全APIで必須（他ユーザーアクセスは `403`）。

## Command APIs (Write)

- `POST /transactions`
- `PATCH /transactions/{id}`
- `DELETE /transactions/{id}`
- `POST /categories`
- `PATCH /categories/{id}`
- `DELETE /categories/{id}`
- `POST /budgets`
- `PATCH /budgets/{id}`
- `DELETE /budgets/{id}`

## Query APIs (Read)

- `GET /ledger/transactions/{id}`
- `GET /ledger/transactions`
- `GET /catalog/categories`
- `GET /planning/budgets`
- `GET /analytics/reports/daily?date=YYYY-MM-DD`
- `GET /analytics/reports/monthly?year=YYYY&month=MM`
- `GET /analytics/reports/yearly?year=YYYY`

## Request / Response Schemas

### TransactionCommandRequest

```json
{
  "type": "expense",
  "amount": 1200,
  "transactionDate": "2026-02-20",
  "categoryId": 10,
  "note": "Lunch"
}
```

### TransactionView

```json
{
  "id": 1,
  "userId": 100,
  "type": "expense",
  "amount": 1200,
  "transactionDate": "2026-02-20",
  "category": {
    "id": 10,
    "name": "Food",
    "type": "expense"
  },
  "note": "Lunch",
  "createdAt": "2026-02-20T10:00:00+09:00",
  "updatedAt": "2026-02-20T10:00:00+09:00"
}
```

### ReportView

```json
{
  "unit": "monthly",
  "year": 2026,
  "month": 2,
  "incomeTotal": 250000,
  "expenseTotal": 180000,
  "balance": 70000
}
```

### ErrorResponse

```json
{
  "code": "VALIDATION_ERROR",
  "message": "amount must be between 1 and 9999999",
  "details": [
    {
      "field": "amount",
      "reason": "out_of_range"
    }
  ]
}
```

## HTTP Status Rules

- `200 OK`: 参照成功
- `201 Created`: 作成成功
- `204 No Content`: 更新/削除成功
- `400 Bad Request`: バリデーション違反
- `401 Unauthorized`: 未認証
- `403 Forbidden`: 他ユーザーリソースへのアクセス
- `404 Not Found`: 対象なし
- `409 Conflict`: 一意制約違反など競合
- `500 Internal Server Error`: 想定外エラー

## OpenAPI Draft

- OpenAPIドラフト: `docs/openapi-draft.yaml`

## Acceptance Criteria

- [x] 各APIの request/response schema がある
- [x] HTTPステータスとエラーフォーマットが定義済み
- [x] OpenAPIドラフトに反映済み
