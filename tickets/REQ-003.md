# REQ-003 業務ルールの確定

- Status: Done
- Priority: Must
- Depends On: REQ-002

## Goal

家計簿ドメインで守るべき業務ルールを明文化する。

## Draft Rules

### 1. Transaction（収支）ルール

- 収支種別は `income` または `expense` のみ。
- `amount` は 1 以上の整数（JPY想定、小数不可）。
- `amount` の上限は 9,999,999。
- `transactionDate` は未来日付不可（当日まで）。
- `categoryId` は必須。
- `note` は任意、最大 255 文字。

### 2. Category（カテゴリ）ルール

- カテゴリ名は必須、1〜30文字。
- 同一ユーザー内でカテゴリ名は重複不可（大文字小文字を区別しない）。
- カテゴリは `income` 用と `expense` 用を分ける。
- 無効化されたカテゴリは新規取引に使えない。
- 既に取引で使用中のカテゴリは削除不可（`inactive` にする）。

### 3. 認可ルール

- ユーザーは自分の `transactions/categories/budgets` のみ参照・更新可能。
- 他ユーザーIDを指定してもアクセス不可（404または403で統一）。

### 4. 更新ルール

- 取引の更新は `amount/type/date/category/note` のみ可能。
- `id/userId/createdAt` は更新不可。
- 更新時も新規作成時と同じ入力ルールを適用する。

### 5. 削除ルール

- 取引削除は論理削除（`deletedAt` を設定）で扱う。
- 集計対象には `deletedAt IS NULL` の取引のみ含める。

### 6. 集計ルール（日・月・年）

- 集計軸は `transactionDate`。
- 日次: 指定日のみ、月次: 指定年月、年次: 指定年。
- 返却値は `incomeTotal`, `expenseTotal`, `balance(incomeTotal - expenseTotal)`。
- 集計対象はログインユーザーのデータのみ。

### 7. エラールール

- バリデーションエラーは 400。
- 認証なしは 401、権限なしは 403（または404方針に統一）。
- 対象なしは 404。
- 想定外エラーは 500。
- エラー形式は共通: `code`, `message`, `details`.

## Domain Mapping (DDD lite)

- Value Object 候補: `Money`, `TransactionType`, `TransactionDate`, `CategoryName`
- Entity 候補: `Transaction`, `Category`, `Budget`
- ドメインサービス候補: `BalanceCalculator`（日/月/年集計）

## Final Decisions

- タイムゾーンは JST 固定。
- 他ユーザーのリソースアクセス時は `403` を返す。
- 金額上限値は 9,999,999 を採用。

## Acceptance Criteria

- [x] 入力ルールと更新ルールが分離して定義されている
- [x] 例外ケース（null、範囲外、不正種別）が定義されている
- [x] ドメインモデルに落とせる粒度で記述されている
