# REQ-006 非機能要件定義

- Status: Done
- Priority: Must
- Depends On: REQ-005

## Goal

運用品質の目標と制約を明確化する。

## Selected Pattern

- Pattern C: 厳格運用型（学習目的で高い運用品質を目指す）

## Non-Functional Requirements

### 1. Security

- 認証: OIDC + JWT（Access Token 15分、Refresh Token 7日）
- 認可: RBAC（`USER`, `ADMIN`）を実装し、全APIで権限検証
- パスワード: Argon2id（メモリコスト強め）
- 通信: TLS前提（本番）
- シークレット: `.env` 直書き禁止、Secrets Manager 管理

### 2. Performance / Availability

- APIレイテンシ目標: `p95 <= 200ms`, `p99 <= 500ms`（通常CRUD）
- 集計API目標: `p95 <= 400ms`
- 可用性目標: 月間 `99.9%`
- 同時接続の目標: 200 req/s でSLOを満たす

### 3. Audit / Logging

- 監査対象: 取引作成・更新・削除、カテゴリ更新、予算更新、ログイン/ログアウト
- 監査ログ項目: `actorId`, `action`, `targetType`, `targetId`, `before`, `after`, `timestamp`, `ip`
- ログ保持: アプリログ90日、監査ログ1年
- 改ざん対策: 監査ログは追記専用ストレージへ転送

### 4. Backup / Disaster Recovery

- DBバックアップ: 日次フル + 15分間隔WALアーカイブ（PITR）
- RPO: 15分
- RTO: 4時間
- リストア演習: 月1回
- 障害時は別環境に復旧手順を持つ

### 5. Monitoring / Alerting

- 監視対象: レイテンシ、エラー率、CPU/メモリ、DB接続数、ディスク、5xx率
- アラート閾値:
  - 5xx率 > 1% が5分継続
  - `p95 > 400ms` が10分継続
  - DB接続使用率 > 80%
- ヘルスチェック: `/actuator/health` と依存先疎通を監視

### 6. Testing Scope

- Unit: Domain/Application 主要ロジック 80%以上
- Integration: Repository + DB + Security フロー
- API: 認証済み/未認証/権限不足/バリデーション違反
- Load test: k6でSLO検証
- Security test: SAST + Dependency Scan + DAST

## To-Do (Implementation Tasks)

1. 認証基盤を OIDC + JWT + RBAC で実装する
2. 監査ログテーブル/転送パイプラインを実装する
3. PrometheusメトリクスとGrafanaダッシュボードを用意する
4. Alertmanager通知ルールを設定する
5. PostgreSQLバックアップと復旧手順を自動化する
6. k6負荷試験シナリオを作成し、SLOを計測する
7. セキュリティスキャン（SAST/Dependency/DAST）をCIに組み込む

## Required Tools

### Auth / Security

- Keycloak（OIDC Provider）
- Spring Security + JWT
- Trivy（Dependency Scan）
- Semgrep or SonarQube（SAST）
- OWASP ZAP（DAST）

### Observability

- Micrometer + Prometheus
- Grafana
- Alertmanager
- Loki or OpenSearch（ログ保管）

### Database / Backup

- PostgreSQL
- pgBackRest（バックアップ/PITR）
- cron or GitHub Actions（定期ジョブ）

### Performance / Testing

- JUnit + Testcontainers
- k6（負荷試験）
- REST Assured（APIテスト）

## Deliverables

- `docs/nfr.md`（非機能要件書）
- `docs/runbook-disaster-recovery.md`（復旧手順）
- `docs/monitoring.md`（監視項目と閾値）
- `docs/security-checklist.md`（セキュリティ運用手順）

## Acceptance Criteria

- [x] 非機能要件に数値目標が含まれている
- [x] セキュリティ要件が明文化されている
- [x] 運用手順の最低限（監視、復旧）が定義されている
