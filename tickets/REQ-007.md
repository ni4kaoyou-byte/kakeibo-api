# REQ-007 受け入れ条件定義

- Status: Done
- Priority: Must
- Depends On: REQ-005, REQ-006

## Goal

各ユースケースの完了判定基準を定義する。

## Scope

- CQRS-lite API（Command/Query）全体
- 認証/認可、バリデーション、監査ログの最低条件

## Acceptance Test Matrix

### A. Transaction Command

| Test ID | API | 条件 | 期待結果 |
|---|---|---|---|
| AC-TX-CMD-001 | `POST /transactions` | 正常入力 | `201` + 作成データを返す |
| AC-TX-CMD-002 | `POST /transactions` | `amount=0` | `400` + `VALIDATION_ERROR` |
| AC-TX-CMD-003 | `POST /transactions` | 未来日付 | `400` + `VALIDATION_ERROR` |
| AC-TX-CMD-004 | `PATCH /transactions/{id}` | 自分の取引を更新 | `204` |
| AC-TX-CMD-005 | `PATCH /transactions/{id}` | 他ユーザー取引ID | `403` |
| AC-TX-CMD-006 | `DELETE /transactions/{id}` | 自分の取引を削除 | `204`（論理削除） |
| AC-TX-CMD-007 | `DELETE /transactions/{id}` | 未認証 | `401` |

### B. Transaction Query

| Test ID | API | 条件 | 期待結果 |
|---|---|---|---|
| AC-TX-QRY-001 | `GET /ledger/transactions/{id}` | 自分の取引ID | `200` + `TransactionView` |
| AC-TX-QRY-002 | `GET /ledger/transactions/{id}` | 他ユーザー取引ID | `403` |
| AC-TX-QRY-003 | `GET /ledger/transactions` | 期間条件あり | `200` + 条件一致データ |
| AC-TX-QRY-004 | `GET /ledger/transactions` | 不正日付フォーマット | `400` |
| AC-TX-QRY-005 | `GET /ledger/transactions` | 未認証 | `401` |

### C. Category Command/Query

| Test ID | API | 条件 | 期待結果 |
|---|---|---|---|
| AC-CAT-001 | `POST /categories` | 正常入力 | `201` |
| AC-CAT-002 | `POST /categories` | 同一ユーザー内重複名 | `409` |
| AC-CAT-003 | `PATCH /categories/{id}` | 自分のカテゴリ更新 | `204` |
| AC-CAT-004 | `PATCH /categories/{id}` | 他ユーザーカテゴリ | `403` |
| AC-CAT-005 | `GET /catalog/categories` | 正常取得 | `200` |

### D. Budget Command/Query

| Test ID | API | 条件 | 期待結果 |
|---|---|---|---|
| AC-BUD-001 | `POST /budgets` | 正常入力 | `201` |
| AC-BUD-002 | `POST /budgets` | `yearMonth` 不正形式 | `400` |
| AC-BUD-003 | `PATCH /budgets/{id}` | 他ユーザー予算 | `403` |
| AC-BUD-004 | `GET /planning/budgets` | 正常取得 | `200` |

### E. Analytics Query

| Test ID | API | 条件 | 期待結果 |
|---|---|---|---|
| AC-RPT-001 | `GET /analytics/reports/daily` | `date` 指定 | `200` + `unit=daily` |
| AC-RPT-002 | `GET /analytics/reports/monthly` | `year/month` 指定 | `200` + `unit=monthly` |
| AC-RPT-003 | `GET /analytics/reports/yearly` | `year` 指定 | `200` + `unit=yearly` |
| AC-RPT-004 | `GET /analytics/reports/monthly` | `month=13` | `400` |
| AC-RPT-005 | `GET /analytics/reports/yearly` | 未認証 | `401` |

### F. Cross-Cutting (Security / Audit / Error Contract)

| Test ID | 対象 | 条件 | 期待結果 |
|---|---|---|---|
| AC-SEC-001 | 全API | JWTなし | `401` |
| AC-SEC-002 | 全API | 他ユーザーリソースアクセス | `403` |
| AC-AUD-001 | Command API | 作成/更新/削除成功時 | 監査ログに `actorId/action/targetId` 記録 |
| AC-ERR-001 | エラーレスポンス | 4xx/5xx発生 | `code/message/details` を返す |

## Completion Conditions

- 上記 Test ID がテストケース（自動/手動）として管理されていること。
- 最低限、Command/Queryそれぞれで正常系・異常系・認可エラー系を1件以上自動化すること。
- セキュリティ要件（401/403）と監査ログ記録を回帰テスト対象に含めること。

## Acceptance Criteria

- [x] 各機能に正常系の条件がある
- [x] 各機能に異常系の条件がある
- [x] 各機能に認可エラーの条件がある
- [x] テストケースへ落とし込める粒度で記載されている
